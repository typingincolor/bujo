#!/bin/sh

# Pre-push hook for bujo
# Runs quality checks appropriate to the files being pushed
#
# Installation:
#   cp scripts/pre-push .git/hooks/pre-push
#   chmod +x .git/hooks/pre-push

set -e  # Exit on first error

# Read push info from stdin
# Format: <local ref> <local sha1> <remote ref> <remote sha1>
ZERO_SHA="0000000000000000000000000000000000000000"
has_code_changes=false
changed_files=""

while read local_ref local_sha remote_ref remote_sha; do
    # Skip deletions (local sha is all zeros)
    if [ "$local_sha" = "$ZERO_SHA" ]; then
        continue
    fi

    # Skip tag pushes
    case "$local_ref" in
        refs/tags/*)
            continue
            ;;
    esac

    # Determine the range of commits being pushed
    if [ "$remote_sha" = "$ZERO_SHA" ]; then
        # New branch - compare against merge-base with main/master
        base=$(git merge-base HEAD origin/main 2>/dev/null || git merge-base HEAD origin/master 2>/dev/null || echo "")
        if [ -n "$base" ]; then
            range="$base..$local_sha"
        else
            # Fallback: just check the last commit
            range="$local_sha~1..$local_sha"
        fi
    else
        range="$remote_sha..$local_sha"
    fi

    # Get list of changed files
    files=$(git diff --name-only "$range" 2>/dev/null || echo "")
    if [ -n "$files" ]; then
        has_code_changes=true
        changed_files="$changed_files
$files"
    fi
done

if [ "$has_code_changes" = "false" ]; then
    echo "‚ÑπÔ∏è  No code changes to validate (tag push or branch deletion). Skipping checks."
    exit 0
fi

# Deduplicate changed files
changed_files=$(echo "$changed_files" | sort -u | grep -v '^$' || true)

if [ -z "$changed_files" ]; then
    echo "‚ÑπÔ∏è  No file changes detected. Skipping checks."
    exit 0
fi

# Detect what types of changes we have
has_go_changes=false
has_frontend_changes=false
has_workflow_changes=false
has_code_changes=false

for file in $changed_files; do
    case "$file" in
        *.go|go.mod|go.sum)
            has_go_changes=true
            has_code_changes=true
            ;;
        frontend/*)
            has_frontend_changes=true
            has_code_changes=true
            ;;
        .github/workflows/*.yml|.github/workflows/*.yaml)
            has_workflow_changes=true
            # Workflows are config but should be linted
            ;;
        *.md|docs/*|.github/*|LICENSE|.gitignore|.claude/*|scripts/*)
            # Documentation/config - doesn't set has_code_changes
            ;;
        *)
            # Unknown file type - treat as code change to be safe
            has_code_changes=true
            ;;
    esac
done

# If only docs/config changed (and no workflows), skip all checks
if [ "$has_code_changes" = "false" ] && [ "$has_workflow_changes" = "false" ]; then
    echo "‚ÑπÔ∏è  Only documentation/config changes. Skipping code checks."
    exit 0
fi

echo "üîç Running pre-push checks..."
echo "   Changed files:"
echo "$changed_files" | head -10 | sed 's/^/     /'
total=$(echo "$changed_files" | wc -l | tr -d ' ')
if [ "$total" -gt 10 ]; then
    echo "     ... and $((total - 10)) more"
fi
echo ""

# Go checks (only if Go files changed)
if [ "$has_go_changes" = "true" ]; then
    echo "üì¶ Go changes detected - running Go checks..."

    # 1. Check formatting
    echo "Checking gofmt..."
    unformatted=$(gofmt -l .)
    if [ -n "$unformatted" ]; then
        echo "‚ùå Files need formatting:"
        echo "$unformatted"
        echo ""
        echo "Run: gofmt -w ."
        exit 1
    fi
    echo "‚úÖ gofmt passed"

    # 2. Check go.mod tidy
    echo "Checking go.mod is tidy..."
    cp go.mod go.mod.backup
    cp go.sum go.sum.backup
    go mod tidy
    if ! diff -q go.mod go.mod.backup > /dev/null 2>&1 || ! diff -q go.sum go.sum.backup > /dev/null 2>&1; then
        echo "‚ùå go.mod or go.sum is not tidy. Run 'go mod tidy' and commit changes."
        mv go.mod.backup go.mod
        mv go.sum.backup go.sum
        exit 1
    fi
    rm go.mod.backup go.sum.backup
    echo "‚úÖ go.mod is tidy"

    # 3. Build all Go code
    echo "Building Go code..."
    if ! go build ./cmd/bujo; then
        echo "‚ùå CLI build failed. Push aborted."
        exit 1
    fi
    if ! go build ./internal/...; then
        echo "‚ùå Internal packages build failed. Push aborted."
        exit 1
    fi
    echo "‚úÖ Go build passed"

    # 4. Run tests
    echo "Running Go tests..."
    if ! go test ./...; then
        echo "‚ùå Tests failed. Push aborted."
        exit 1
    fi
    echo "‚úÖ Go tests passed"

    # 5. Run go vet
    echo "Running go vet..."
    if ! go vet ./...; then
        echo "‚ùå go vet failed. Push aborted."
        exit 1
    fi
    echo "‚úÖ go vet passed"

    # 6. Run golangci-lint
    echo "Running golangci-lint..."
    if ! command -v golangci-lint &> /dev/null; then
        echo "‚ö†Ô∏è  golangci-lint not found, skipping"
    else
        if ! golangci-lint run; then
            echo "‚ùå golangci-lint failed. Push aborted."
            exit 1
        fi
        echo "‚úÖ golangci-lint passed"
    fi
else
    echo "‚ÑπÔ∏è  No Go changes - skipping Go checks"
fi

# Frontend checks (only if frontend files changed)
if [ "$has_frontend_changes" = "true" ] && [ -d "frontend" ]; then
    echo ""
    echo "üåê Frontend changes detected - running frontend checks..."

    echo "Running frontend lint..."
    if ! (cd frontend && npm run lint); then
        echo "‚ùå Frontend lint failed. Push aborted."
        exit 1
    fi
    echo "‚úÖ Frontend lint passed"

    echo "Running TypeScript check..."
    if ! (cd frontend && npx tsc --noEmit); then
        echo "‚ùå TypeScript check failed. Push aborted."
        exit 1
    fi
    echo "‚úÖ TypeScript check passed"

    echo "Running frontend tests..."
    if ! (cd frontend && npm test); then
        echo "‚ùå Frontend tests failed. Push aborted."
        exit 1
    fi
    echo "‚úÖ Frontend tests passed"

    echo "Running frontend build..."
    if ! (cd frontend && npm run build); then
        echo "‚ùå Frontend build failed. Push aborted."
        exit 1
    fi
    echo "‚úÖ Frontend build passed"

    echo "Running npm audit..."
    if ! (cd frontend && npm audit --audit-level=high); then
        echo "‚ùå npm audit found high severity vulnerabilities. Push aborted."
        exit 1
    fi
    echo "‚úÖ npm audit passed"
elif [ "$has_frontend_changes" = "true" ]; then
    echo "‚ÑπÔ∏è  Frontend changes but no frontend directory - skipping frontend checks"
else
    echo "‚ÑπÔ∏è  No frontend changes - skipping frontend checks"
fi

# Workflow checks (only if workflow files changed)
if [ "$has_workflow_changes" = "true" ]; then
    echo ""
    echo "‚öôÔ∏è  Workflow changes detected - running workflow checks..."

    echo "Running actionlint..."
    if ! command -v actionlint &> /dev/null; then
        echo "‚ö†Ô∏è  actionlint not found, skipping (install: brew install actionlint)"
    else
        # Find changed workflow files
        workflow_files=$(echo "$changed_files" | grep -E '\.github/workflows/.*\.ya?ml$' || true)
        if [ -n "$workflow_files" ]; then
            for wf in $workflow_files; do
                if [ -f "$wf" ]; then
                    echo "  Linting $wf..."
                    if ! actionlint "$wf"; then
                        echo "‚ùå actionlint failed for $wf. Push aborted."
                        exit 1
                    fi
                fi
            done
            echo "‚úÖ actionlint passed"
        fi
    fi
else
    echo "‚ÑπÔ∏è  No workflow changes - skipping workflow checks"
fi

echo ""
echo "‚úÖ All pre-push checks passed. Proceeding with push."
