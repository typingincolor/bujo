#!/bin/sh

# Pre-push hook for bujo
# Runs quality checks before allowing push
#
# Installation:
#   cp scripts/pre-push .git/hooks/pre-push
#   chmod +x .git/hooks/pre-push

set -e  # Exit on first error

echo "ğŸ” Running pre-push checks..."

# 1. Check formatting
echo "Checking gofmt..."
unformatted=$(gofmt -l .)
if [ -n "$unformatted" ]; then
    echo "âŒ Files need formatting:"
    echo "$unformatted"
    echo ""
    echo "Run: gofmt -w ."
    exit 1
fi
echo "âœ… gofmt passed"

# 2. Check go.mod tidy
echo "Checking go.mod is tidy..."
cp go.mod go.mod.backup
cp go.sum go.sum.backup
go mod tidy
if ! diff -q go.mod go.mod.backup > /dev/null 2>&1 || ! diff -q go.sum go.sum.backup > /dev/null 2>&1; then
    echo "âŒ go.mod or go.sum is not tidy. Run 'go mod tidy' and commit changes."
    mv go.mod.backup go.mod
    mv go.sum.backup go.sum
    exit 1
fi
rm go.mod.backup go.sum.backup
echo "âœ… go.mod is tidy"

# 3. Build all Go code (CLI and internal packages including TUI)
echo "Building Go code..."
if ! go build ./cmd/bujo; then
    echo "âŒ CLI build failed. Push aborted."
    exit 1
fi
if ! go build ./internal/...; then
    echo "âŒ Internal packages build failed. Push aborted."
    exit 1
fi
echo "âœ… Go build passed"

# 4. Run tests
echo "Running tests..."
if ! go test ./...; then
    echo "âŒ Tests failed. Push aborted."
    exit 1
fi
echo "âœ… Tests passed"

# 5. Run go vet
echo "Running go vet..."
if ! go vet ./...; then
    echo "âŒ go vet failed. Push aborted."
    exit 1
fi
echo "âœ… go vet passed"

# 6. Run golangci-lint
echo "Running golangci-lint..."
if ! command -v golangci-lint &> /dev/null; then
    echo "âš ï¸  golangci-lint not found, skipping"
else
    if ! golangci-lint run; then
        echo "âŒ golangci-lint failed. Push aborted."
        exit 1
    fi
    echo "âœ… golangci-lint passed"
fi

# 7-11. Frontend checks (only if frontend directory exists)
if [ -d "frontend" ]; then
    echo "Running frontend lint..."
    if ! (cd frontend && npm run lint); then
        echo "âŒ Frontend lint failed. Push aborted."
        exit 1
    fi
    echo "âœ… Frontend lint passed"

    echo "Running TypeScript check..."
    if ! (cd frontend && npx tsc --noEmit); then
        echo "âŒ TypeScript check failed. Push aborted."
        exit 1
    fi
    echo "âœ… TypeScript check passed"

    echo "Running frontend tests..."
    if ! (cd frontend && npm test); then
        echo "âŒ Frontend tests failed. Push aborted."
        exit 1
    fi
    echo "âœ… Frontend tests passed"

    echo "Running frontend build..."
    if ! (cd frontend && npm run build); then
        echo "âŒ Frontend build failed. Push aborted."
        exit 1
    fi
    echo "âœ… Frontend build passed"

    echo "Running npm audit..."
    if ! (cd frontend && npm audit --audit-level=high); then
        echo "âŒ npm audit found high severity vulnerabilities. Push aborted."
        exit 1
    fi
    echo "âœ… npm audit passed"
else
    echo "â„¹ï¸  Frontend directory not found, skipping frontend checks"
fi

echo ""
echo "âœ… All pre-push checks passed. Proceeding with push."
