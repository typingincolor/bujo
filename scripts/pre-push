#!/bin/sh

# Pre-push hook for bujo
# Runs quality checks before allowing push
#
# Installation:
#   cp scripts/pre-push .git/hooks/pre-push
#   chmod +x .git/hooks/pre-push

set -e  # Exit on first error

echo "ğŸ” Running pre-push checks..."

# 1. Check formatting
echo "Checking gofmt..."
unformatted=$(gofmt -l .)
if [ -n "$unformatted" ]; then
    echo "âŒ Files need formatting:"
    echo "$unformatted"
    echo ""
    echo "Run: gofmt -w ."
    exit 1
fi
echo "âœ… gofmt passed"

# 2. Run tests
echo "Running tests..."
if ! go test ./...; then
    echo "âŒ Tests failed. Push aborted."
    exit 1
fi
echo "âœ… Tests passed"

# 3. Run go vet
echo "Running go vet..."
if ! go vet ./...; then
    echo "âŒ go vet failed. Push aborted."
    exit 1
fi
echo "âœ… go vet passed"

# 4. Run golangci-lint
echo "Running golangci-lint..."
if ! command -v golangci-lint &> /dev/null; then
    echo "âš ï¸  golangci-lint not found, skipping"
else
    if ! golangci-lint run; then
        echo "âŒ golangci-lint failed. Push aborted."
        exit 1
    fi
    echo "âœ… golangci-lint passed"
fi

# 5. Frontend lint
echo "Running frontend lint..."
if ! (cd frontend && npm run lint); then
    echo "âŒ Frontend lint failed. Push aborted."
    exit 1
fi
echo "âœ… Frontend lint passed"

# 6. Frontend tests
echo "Running frontend tests..."
if ! (cd frontend && npm test); then
    echo "âŒ Frontend tests failed. Push aborted."
    exit 1
fi
echo "âœ… Frontend tests passed"

# 7. Frontend build
echo "Running frontend build..."
if ! (cd frontend && npm run build); then
    echo "âŒ Frontend build failed. Push aborted."
    exit 1
fi
echo "âœ… Frontend build passed"

echo ""
echo "âœ… All pre-push checks passed. Proceeding with push."
