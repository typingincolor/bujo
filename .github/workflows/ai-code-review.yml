name: AI Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - '**.go'
      - '**_test.go'

permissions:
  contents: read
  pull-requests: write

jobs:
  review:
    runs-on: ubuntu-latest
    if: github.actor != 'dependabot[bot]'
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Get PR diff
        id: diff
        run: |
          # Get the diff between base and head
          git fetch origin ${{ github.base_ref }}
          DIFF=$(git diff origin/${{ github.base_ref }}...HEAD -- '*.go' '*_test.go' | head -c 30000)

          # Save to file to handle special characters
          echo "$DIFF" > /tmp/pr-diff.txt

          # Check if there are Go changes
          if [ -z "$DIFF" ]; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: AI Code Review
        if: steps.diff.outputs.has_changes == 'true'
        uses: actions/github-script@v7
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        with:
          script: |
            const fs = require('fs');
            const https = require('https');

            // Read diff
            const diff = fs.readFileSync('/tmp/pr-diff.txt', 'utf8');

            // Read CLAUDE.md for context
            let claudeContext = '';
            try {
              claudeContext = fs.readFileSync('.claude/CLAUDE.md', 'utf8');
            } catch (e) {
              console.log('No CLAUDE.md found, proceeding without project context');
            }

            const prompt = `You are reviewing a Go pull request for TDD compliance and code quality.

            Project Context:
            ${claudeContext.substring(0, 2000)}

            PR Diff:
            ${diff.substring(0, 25000)}

            Review this PR for:
            1. TDD Compliance: Were tests written first? Are there new production functions without corresponding tests?
            2. Hexagonal Architecture: Are domain/service/repository layers properly separated?
            3. Event Sourcing: Do repository changes follow event sourcing pattern (create new versions, don't UPDATE)?
            4. Functional Patterns: Immutability, pure functions, early returns
            5. Test Quality: Do tests check behavior not implementation?

            Provide constructive feedback in markdown format. Be specific about file:line locations.
            If everything looks good, say "âœ… Looks good!" and highlight what was done well.
            Focus on the most important issues only (max 3-4 points).`;

            // Call Anthropic API
            const apiKey = process.env.ANTHROPIC_API_KEY;
            if (!apiKey) {
              console.log('âš ï¸ ANTHROPIC_API_KEY not set, skipping AI review');
              return;
            }

            const requestData = JSON.stringify({
              model: 'claude-3-5-sonnet-20241022',
              max_tokens: 2000,
              messages: [{
                role: 'user',
                content: prompt
              }]
            });

            const options = {
              hostname: 'api.anthropic.com',
              path: '/v1/messages',
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'x-api-key': apiKey,
                'anthropic-version': '2023-06-01',
                'Content-Length': Buffer.byteLength(requestData)
              }
            };

            const response = await new Promise((resolve, reject) => {
              const req = https.request(options, (res) => {
                let data = '';
                res.on('data', chunk => data += chunk);
                res.on('end', () => resolve(JSON.parse(data)));
              });
              req.on('error', reject);
              req.write(requestData);
              req.end();
            });

            const review = response.content[0].text;

            // Check if already reviewed
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            const botComment = comments.find(c =>
              c.user.type === 'Bot' && c.body.includes('ðŸ¤– AI Code Review')
            );

            const commentBody = `## ðŸ¤– AI Code Review

            ${review}

            ---
            *This review was automatically generated using Claude. Focus areas: TDD, Architecture, Event Sourcing, Functional Patterns.*`;

            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: commentBody
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: commentBody
              });
            }
