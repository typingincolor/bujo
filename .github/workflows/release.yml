name: Release

on:
  workflow_run:
    workflows: [CI]
    types: [completed]

permissions:
  contents: write

jobs:
  release:
    name: Release
    runs-on: macos-latest
    if: |
      github.event.workflow_run.conclusion == 'success' &&
      startsWith(github.event.workflow_run.head_branch, 'v')
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_branch }}
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Install llama.cpp
        run: brew install llama.cpp

      - name: Tidy modules
        run: go mod tidy

      - name: Initialize llama.cpp submodule for go-llama.cpp bindings
        run: |
          # go-llama.cpp expects llama.cpp source as a submodule
          LLAMA_GO_PATH=$(go env GOPATH)/pkg/mod/github.com/go-skynet/go-llama.cpp@v0.0.0-20240314183750-6a8041ef6b46
          if [ -d "$LLAMA_GO_PATH" ] && [ ! -d "$LLAMA_GO_PATH/llama.cpp" ]; then
            cd "$LLAMA_GO_PATH"
            chmod -R u+w .
            git clone --depth 1 https://github.com/ggerganov/llama.cpp llama.cpp
          fi

      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@v6
        with:
          distribution: goreleaser
          version: latest
          args: release --clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          HOMEBREW_TAP_TOKEN: ${{ secrets.HOMEBREW_TAP_SECRET }}
