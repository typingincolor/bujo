name: Rename Releases to Build Numbers

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (no changes made)'
        required: false
        default: 'true'
        type: boolean

permissions:
  contents: write

jobs:
  rename:
    name: Rename Releases
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Rename releases
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DRY_RUN: ${{ inputs.dry_run }}
        run: |
          set -e

          echo "Fetching all releases..."
          RELEASES=$(gh release list --limit 100 --json tagName,name,body,isDraft,isPrerelease)

          # Get releases sorted by version (oldest first for sequential numbering)
          SORTED_TAGS=$(echo "$RELEASES" | jq -r '.[].tagName' | sort -V)

          BUILD_NUM=1
          for TAG in $SORTED_TAGS; do
            # Skip if already a build-N tag
            if [[ "$TAG" =~ ^build-[0-9]+$ ]]; then
              echo "Skipping $TAG (already renamed)"
              EXISTING_NUM=$(echo "$TAG" | sed 's/build-//')
              if [ "$EXISTING_NUM" -ge "$BUILD_NUM" ]; then
                BUILD_NUM=$((EXISTING_NUM + 1))
              fi
              continue
            fi

            NEW_TAG="build-${BUILD_NUM}"
            echo ""
            echo "=== Renaming $TAG -> $NEW_TAG ==="

            if [ "$DRY_RUN" == "true" ]; then
              echo "[DRY RUN] Would rename $TAG to $NEW_TAG"
            else
              # Get release details and write body to temp file for multiline support
              BODY_FILE=$(mktemp)
              echo "$RELEASES" | jq -r --arg tag "$TAG" '.[] | select(.tagName == $tag) | .body // ""' > "$BODY_FILE"
              IS_DRAFT=$(echo "$RELEASES" | jq -r --arg tag "$TAG" '.[] | select(.tagName == $tag) | .isDraft')
              IS_PRERELEASE=$(echo "$RELEASES" | jq -r --arg tag "$TAG" '.[] | select(.tagName == $tag) | .isPrerelease')

              # Get the commit SHA for this tag
              COMMIT_SHA=$(git rev-list -n 1 "$TAG" 2>/dev/null || echo "")

              if [ -z "$COMMIT_SHA" ]; then
                echo "Warning: Could not find commit for tag $TAG, fetching..."
                git fetch origin "refs/tags/$TAG:refs/tags/$TAG" || true
                COMMIT_SHA=$(git rev-list -n 1 "$TAG" 2>/dev/null || echo "")
              fi

              if [ -z "$COMMIT_SHA" ]; then
                echo "Error: Could not find commit for tag $TAG, skipping"
                rm -f "$BODY_FILE"
                continue
              fi

              echo "Commit SHA: $COMMIT_SHA"

              # Create new tag pointing to same commit
              git tag "$NEW_TAG" "$COMMIT_SHA"
              git push origin "$NEW_TAG"

              # Download assets from old release
              ASSET_DIR=$(mktemp -d)
              echo "Downloading assets to $ASSET_DIR..."
              gh release download "$TAG" --dir "$ASSET_DIR" 2>/dev/null || echo "No assets to download"

              # Build gh release create command
              CREATE_CMD="gh release create \"$NEW_TAG\" --title \"$NEW_TAG\" --notes-file \"$BODY_FILE\""
              if [ "$IS_PRERELEASE" == "true" ]; then
                CREATE_CMD="$CREATE_CMD --prerelease"
              fi
              if [ "$IS_DRAFT" == "true" ]; then
                CREATE_CMD="$CREATE_CMD --draft"
              fi

              # Add assets if any exist
              if [ -n "$(ls -A "$ASSET_DIR" 2>/dev/null)" ]; then
                for asset in "$ASSET_DIR"/*; do
                  CREATE_CMD="$CREATE_CMD \"$asset\""
                done
              fi

              # Create new release
              echo "Creating release: $CREATE_CMD"
              eval "$CREATE_CMD"

              # Delete old release and tag
              echo "Deleting old release $TAG..."
              gh release delete "$TAG" --yes
              git push origin --delete "$TAG"

              rm -rf "$ASSET_DIR" "$BODY_FILE"
              echo "Successfully renamed $TAG -> $NEW_TAG"
            fi

            BUILD_NUM=$((BUILD_NUM + 1))
          done

          echo ""
          echo "=== Complete ==="
          echo "Next build number will be: $BUILD_NUM"
